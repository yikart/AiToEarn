# AI功能模块实现文档

## 概述
本次更新将发布弹窗的左侧"写作助手"改造为全新的"AI功能模块"，提供了多种AI辅助创作功能，并增加了划词快捷操作。

## 新增功能

### 1. AI助手功能模块
位置：左侧面板（PublishDialogAi组件）

#### 支持的AI功能：
1. **缩写 (Shorten Text)**
   - 将过长的文本缩短，符合平台要求
   - 保持核心信息不变

2. **扩写 (Expand Text)**
   - 扩展文本内容，增加更多细节
   - 支持自定义默认提示词（可折叠编辑）

3. **润色 (Polish Writing)**
   - 优化文本表达，使其更流畅专业
   - 支持自定义默认提示词（可折叠编辑）

4. **翻译 (Translate)**
   - 将文本翻译成目标语言
   - 需要用户输入目标语言（如：英文、日文、法文）

5. **制图 (Generate Image)**
   - 根据文本生成图片创作提示词
   - 界面改为图片生成模式

6. **创作视频 (Generate Video)**
   - 根据文本生成视频创作提示词
   - 界面改为视频生成模式

### 2. 划词快捷操作
位置：中间编辑区域（TextSelectionToolbar组件）

**使用方法：**
- 在文本编辑区域选中任意文本
- 自动弹出快捷操作工具栏
- 点击对应功能按钮，将选中文本发送到左侧AI助手处理

**支持的快捷操作：**
- 缩写、扩写、润色、翻译、制图、创作视频

### 3. AI对话同步功能
**功能说明：**
- AI返回结果后，每条对话下方显示"同步到编辑器"按钮
- 点击后将AI生成的内容同步到中间的文本编辑器
- 支持复制到剪贴板功能

**同步逻辑：**
- 单账号模式：直接更新该账号的描述内容
- 多账号模式（第一步）：更新公共参数的描述
- 多账号模式（第二步）：更新当前展开账号的描述

## 技术实现

### 新增/修改的文件

#### 1. API接口 (`src/api/ai.ts`)
- 新增 `aiChatStream` 函数
- 支持流式响应
- 自动携带认证token和语言设置
- 接口地址：`https://aitoearn.ai/api/ai/chat`

**请求参数：**
```typescript
{
  messages: Array<{ role: string, content: string }>,
  stream: boolean,
  model: string,
  temperature: number,
  presence_penalty: number,
  frequency_penalty: number,
  top_p: number,
  max_tokens: number
}
```

#### 2. AI助手组件 (`src/components/PublishDialog/compoents/PublishDialogAi.tsx`)
- 重构为全新的AI功能模块
- 使用Tabs切换不同AI功能
- 实现流式聊天响应
- 支持多会话管理（每个功能独立会话）
- 提供同步和复制功能

**主要功能：**
- `processText(text, action)`: 接收划词选中的文本并处理
- 流式响应显示
- 会话历史记录
- 自定义提示词编辑（扩写、润色）

#### 3. 划词工具栏 (`src/components/PublishDialog/compoents/TextSelectionToolbar.tsx`)
- 监听文本选择事件
- 自动定位到选中文本上方
- 提供快捷操作按钮
- 点击外部自动隐藏

**样式文件：** `TextSelectionToolbar.module.scss`
- 优雅的动画效果
- 响应式设计

#### 4. 主弹窗组件 (`src/components/PublishDialog/index.tsx`)
- 集成划词工具栏
- 添加AI助手ref引用
- 实现 `handleTextSelection` 处理划词操作
- 实现 `handleSyncToEditor` 同步内容到编辑器
- 支持左侧AI面板的开关

#### 5. 国际化翻译 (`src/app/i18n/locales/zh-CN/publish.json`)
- 新增 `aiAssistant` 标题
- 新增 `aiFeatures` 相关翻译
  - 各功能名称
  - 提示词模板
  - 交互文案

## 使用流程

### 方式一：直接使用AI功能
1. 点击发布弹窗左上角打开AI助手
2. 选择需要的功能标签（缩写、扩写、润色等）
3. 输入内容并发送
4. 等待AI响应
5. 点击"同步到编辑器"应用结果

### 方式二：划词快捷操作
1. 在中间编辑区域选中需要处理的文本
2. 在弹出的工具栏中点击对应功能
3. 左侧AI助手自动打开并开始处理
4. 查看结果并同步到编辑器

## 布局说明

```
┌─────────────────────────────────────────────────────────┐
│                    发布作品弹窗                           │
├─────────────┬─────────────────┬────────────────────────┤
│             │                 │                        │
│   AI助手    │   发布编辑区域   │       预览区域         │
│  (左侧面板)  │   (中间面板)     │      (右侧面板)        │
│             │                 │                        │
│  - 缩写      │  - 账号选择     │   - 内容预览          │
│  - 扩写      │  - 文本编辑     │   - 格式预览          │
│  - 润色      │  - 媒体上传     │                       │
│  - 翻译      │  - 参数设置     │                       │
│  - 制图      │                 │                       │
│  - 视频      │  [划词工具栏]   │                       │
│             │                 │                        │
└─────────────┴─────────────────┴────────────────────────┘
```

## 注意事项

1. **API认证**
   - AI聊天接口需要用户登录
   - 自动携带Bearer Token
   - 401错误会自动触发登录流程

2. **流式响应**
   - 使用SSE（Server-Sent Events）流式传输
   - 实时显示AI生成内容
   - 网络中断会自动停止

3. **会话管理**
   - 每个AI功能维护独立会话
   - 切换标签保留历史记录
   - 刷新页面清空所有会话

4. **性能优化**
   - 使用React.memo避免不必要的重渲染
   - 流式响应减少等待时间
   - 防抖处理文本选择事件

## 后续优化建议

1. **会话持久化**
   - 将会话历史保存到localStorage
   - 支持会话历史查看和管理

2. **提示词库**
   - 提供预设提示词模板
   - 支持用户自定义并保存提示词

3. **多轮对话**
   - 支持连续对话
   - 上下文理解优化

4. **图片和视频生成**
   - 完善制图和视频生成功能
   - 集成实际的图片/视频生成API

5. **快捷键支持**
   - 添加键盘快捷键
   - 提升操作效率

## 测试建议

1. 测试各个AI功能的正常响应
2. 测试划词工具栏在不同场景下的表现
3. 测试同步功能在单账号/多账号模式下的正确性
4. 测试网络异常情况的错误处理
5. 测试流式响应的中断和恢复
6. 测试在不同屏幕尺寸下的响应式布局

## 问题反馈

如遇到问题，请检查：
1. 用户是否已登录
2. 网络连接是否正常
3. API接口是否可访问
4. 浏览器控制台是否有错误信息

---

**实现日期：** 2025-11-18
**版本：** 1.0.0

