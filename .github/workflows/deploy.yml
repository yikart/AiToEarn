name: Deploy Service

on:
  workflow_dispatch:
    inputs:
      environment:
        description: é€‰æ‹©ç›®æ ‡ç¯å¢ƒ
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      version:
        description: é•œåƒç‰ˆæœ¬ (ç•™ç©ºä½¿ç”¨é»˜è®¤ç”Ÿæˆè§„åˆ™)
        required: false
        type: string
      architectures:
        description: ç›®æ ‡å¹³å° (é€—å·åˆ†éš”ï¼Œå¦‚ linux/amd64,linux/arm64)
        required: false
        type: string
        default: linux/amd64
      app_name:
        description: è¦æ„å»ºçš„ Nx åº”ç”¨å (apps/<name>)
        required: true
        type: choice
        options:
          - aitoearn-ai
          - aitoearn-cloud-space
          - aitoearn-user
          - aitoearn-other
          - aitoearn-payment
          - aitoearn-server

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-southeast-1
  ECR_REGISTRY: 339388639667.dkr.ecr.ap-southeast-1.amazonaws.com
  ROLE_TO_ASSUME: arn:aws:iam::339388639667:role/GithubActions
  IMAGE_REPO: aitoearn
  APP_NAME: ${{ github.event.inputs.app_name }}
  HELM_REPO: yikart/k8s-apps
  HELM_REPO_URL: https://github.com/yikart/k8s-apps.git

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm nx run ${{ env.APP_NAME }}:build

      - name: Prepare Docker context
        run: pnpm nx run ${{ env.APP_NAME }}:docker-context

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(date +%Y%m%d)-$(git rev-parse --short HEAD)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build and push application
        uses: docker/build-push-action@v5
        with:
          context: ./tmp/docker-context
          file: ./tmp/docker-context/Dockerfile
          push: true
          tags: ${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.APP_NAME }}:${{ steps.version.outputs.version }}
          platforms: ${{ github.event.inputs.architectures }}
          build-args: |
            APP_NAME=${{ env.APP_NAME }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: yikart
          repositories: k8s-apps

      - name: Clone Helm repository
        uses: actions/checkout@v5
        with:
          repository: ${{ env.HELM_REPO }}
          token: ${{ steps.generate-token.outputs.token }}
          path: k8s-apps

      - name: Update Helm values
        run: |
          cd k8s-apps
          ENV="${{ github.event.inputs.environment }}"
          VERSION="${{ steps.version.outputs.version }}"
          APP="${{ env.APP_NAME }}"
          VALUES_FILE="${ENV}/values-${APP}.yaml"

          if [ -f "$VALUES_FILE" ]; then
            sed -i "s|tag: .*|tag: ${VERSION}|g" "$VALUES_FILE"
            echo "Updated ${APP} tag to ${VERSION}"
          else
            echo "Warning: Values file not found: $VALUES_FILE"
          fi

      - name: Update config files
        run: |
          ENV="${{ github.event.inputs.environment }}"
          CONFIG_FILE="apps/${{ env.APP_NAME }}/config/${ENV}.config.js"
          if [ -f "$CONFIG_FILE" ]; then
            CONFIG_DIR="k8s-apps/${ENV}/configmaps/${{ env.APP_NAME }}"
            mkdir -p "$CONFIG_DIR"
            cp "$CONFIG_FILE" "${CONFIG_DIR}/config.js"
            echo "Updated ${{ env.APP_NAME }} config for ${ENV} environment"
          else
            echo "Warning: Config file not found: $CONFIG_FILE"
          fi

      - name: Get source repository changes
        id: source-changes
        run: |
          COMMIT_HISTORY=$(git log --oneline -10 --pretty=format:"- [%h](${{ github.server_url }}/${{ github.repository }}/commit/%H) %s")
          echo 'commit_history<<EOF' >> $GITHUB_OUTPUT
          echo "$COMMIT_HISTORY" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Create Pull Request in Helm Repo
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.generate-token.outputs.token }}
          path: ./k8s-apps
          branch: deploy/${{ env.APP_NAME }}-${{ github.event.inputs.environment }}-${{ steps.version.outputs.version }}
          title: 'deploy(${{ github.event.inputs.environment }}): update ${{ env.APP_NAME }} to ${{ steps.version.outputs.version }}'
          body: |
            ## ğŸš€ éƒ¨ç½²è¯·æ±‚

            **åº”ç”¨**: ${{ env.APP_NAME }}
            **ç¯å¢ƒ**: ${{ github.event.inputs.environment }}
            **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}

            ### ğŸ“‹ å˜æ›´è¯¦æƒ…

            - æ›´æ–°é•œåƒæ ‡ç­¾: `${{ env.APP_NAME }}:${{ steps.version.outputs.version }}`
            - ç›®æ ‡ç¯å¢ƒ: `${{ github.event.inputs.environment }}`

            ### ğŸ“ æºä»£ç å˜æ›´å†å²

            æœ€è¿‘çš„æäº¤è®°å½•ï¼š
            ${{ steps.source-changes.outputs.commit_history }}

            ### ğŸ”— ç›¸å…³ä¿¡æ¯

            - **æºä»“åº“**: ${{ github.repository }}
            - **æºæäº¤**: [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
            - **é•œåƒåœ°å€**: `${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.APP_NAME }}:${{ steps.version.outputs.version }}`
            - **æ„å»ºæ—¥å¿—**: [GitHub Actions Run ${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          commit-message: |
            deploy(${{ github.event.inputs.environment }}): update ${{ env.APP_NAME }} to ${{ steps.version.outputs.version }}

            Update image tag for ${{ env.APP_NAME }} in ${{ github.event.inputs.environment }} environment
            Source-Commit: ${{ github.sha }}
            Triggered-By: GitHub Actions
          base: main

      - name: Summary
        if: always()
        run: |
          echo "## ğŸ“¦éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨**: ${{ env.APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¯å¢ƒ**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é•œåƒ**: \`${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}/${{ env.APP_NAME }}:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.create-pr.outputs.pull-request-number }}" != "" ]; then
            echo "- **çŠ¶æ€**: âœ… Pull Request å·²åˆ›å»ºåˆ° Helm ä»“åº“" >> $GITHUB_STEP_SUMMARY
            echo "- **PRé“¾æ¥**: ${{ steps.create-pr.outputs.pull-request-url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **çŠ¶æ€**: âš ï¸ æ— å˜æ›´ï¼Œæœªåˆ›å»º Pull Request" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— å¿«é€Ÿé“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [Helm ä»“åº“](${{ env.HELM_REPO_URL }})" >> $GITHUB_STEP_SUMMARY
          echo "- [æºä»£ç æäº¤](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
