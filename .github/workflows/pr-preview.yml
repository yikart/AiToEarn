name: Backend PR Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: ap-southeast-1
  ECR_REGISTRY: 339388639667.dkr.ecr.ap-southeast-1.amazonaws.com
  IMAGE_REPO: aitoearn
  INFRASTRUCTURE_REPO: terraform

jobs:
  # æ„å»ºå¹¶æ¨é€é•œåƒ
  build-and-push:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest

    outputs:
      apps: ${{ steps.generate-apps.outputs.apps }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ä½¿ç”¨ Nx æ£€æµ‹å—å½±å“çš„åº”ç”¨
      - name: Detect affected apps
        id: detect-changes
        run: |
          # è®¾ç½® base åˆ†æ”¯
          BASE_REF="origin/${{ github.base_ref }}"

          echo "ğŸ” æ£€æµ‹å—å½±å“çš„åº”ç”¨..."
          echo "Base: $BASE_REF"
          echo "Head: HEAD"

          # ä½¿ç”¨ Nx affected å‘½ä»¤æ£€æµ‹å—å½±å“çš„åº”ç”¨
          # --type=app åªæ£€æµ‹åº”ç”¨ï¼ˆä¸åŒ…æ‹¬åº“ï¼‰
          # --base æŒ‡å®šæ¯”è¾ƒçš„åŸºå‡†åˆ†æ”¯
          AFFECTED_APPS=$(pnpm nx show projects --affected --type=app --sep "," --exclude="@yikart/source" --exclude="browser-automation-worker" --base=$BASE_REF --head=HEAD 2>/dev/null || echo "")

          if [ -z "$AFFECTED_APPS" ]; then
            echo "âš ï¸  æœªæ£€æµ‹åˆ°å—å½±å“çš„åº”ç”¨"
            echo "changed_apps=" >> $GITHUB_OUTPUT
          else
            echo "âœ… å—å½±å“çš„åº”ç”¨: $CHANGED_APPS"
            echo "changed_apps=$CHANGED_APPS" >> $GITHUB_OUTPUT

            # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
            echo ""
            echo "ğŸ“Š è¯¦ç»†ä¿¡æ¯:"
            for APP in $(echo "$AFFECTED_APPS"); do
              echo "  - $APP"
            done
          fi

      - name: Configure AWS credentials
        if: steps.detect-changes.outputs.changed_apps != ''
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        if: steps.detect-changes.outputs.changed_apps != ''
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        if: steps.detect-changes.outputs.changed_apps != ''
        uses: docker/setup-buildx-action@v3

      - name: Generate version
        id: version
        run: |
          VERSION="$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"

      - name: Build and push Docker images
        if: steps.detect-changes.outputs.changed_apps != ''
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IFS=',' read -ra APPS <<< "${{ steps.detect-changes.outputs.changed_apps }}"

          for APP in "${APPS[@]}"; do
            echo "ğŸ”¨ æ„å»ºåº”ç”¨: $APP"

            # æ„å»ºåº”ç”¨
            pnpm nx run $APP:build

            # å‡†å¤‡ Docker context
            pnpm nx run $APP:docker-context

            echo "ğŸ‹ æ„å»º Docker é•œåƒ: $APP"

            IMAGE_TAG="${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}/$APP:$VERSION"

            # ä½¿ç”¨ docker/build-push-action çš„ç­‰æ•ˆå‘½ä»¤ï¼Œä½†æ”¯æŒå¾ªç¯
            docker buildx build \
              --platform linux/amd64 \
              --file ./tmp/docker-context/Dockerfile \
              --build-arg APP_NAME=$APP \
              --tag $IMAGE_TAG \
              --push \
              --cache-from type=gha,scope=$APP \
              --cache-to type=gha,mode=max,scope=$APP \
              --provenance=false \
              --sbom=false \
              ./tmp/docker-context

            echo "âœ… æ¨é€é•œåƒ: $IMAGE_TAG"
          done

      # ç”Ÿæˆåº”ç”¨é…ç½®
      - name: Generate apps configuration
        if: steps.detect-changes.outputs.changed_apps != ''
        id: generate-apps
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          IFS=',' read -ra APPS <<< "${{ steps.detect-changes.outputs.changed_apps }}"

          # å›ºå®šçš„å¥åº·æ£€æŸ¥è·¯å¾„
          HEALTH_PATH="/health"

          # æ„å»º JSON é…ç½®
          APPS_JSON="{"
          FIRST=true

          for APP in "${APPS[@]}"; do
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              APPS_JSON="$APPS_JSON,"
            fi

            CONFIG_FILE="apps/$APP/config/config.js"

            if [ ! -f "$CONFIG_FILE" ]; then
              echo "âŒ é”™è¯¯: åº”ç”¨ $APP çš„é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE"
              exit 1
            fi

            PORT=$(grep -oP 'port:\s*\K\d+' "$CONFIG_FILE" 2>/dev/null || echo "")

            if [ -z "$PORT" ]; then
              echo "âŒ é”™è¯¯: æ— æ³•ä» $CONFIG_FILE è¯»å–ç«¯å£å·"
              echo "   è¯·ç¡®ä¿é…ç½®æ–‡ä»¶ä¸­åŒ…å« 'port: <ç«¯å£å·>' æ ¼å¼"
              exit 1
            fi

            echo "  âœ“ $APP ç«¯å£: $PORT"

            APPS_JSON="$APPS_JSON\"$APP\":{\"image\":\"${{ env.ECR_REGISTRY }}/${{ env.IMAGE_REPO }}/$APP:$VERSION\",\"port\":\"$PORT\",\"health_check\":{\"path\":\"$HEALTH_PATH\"}}"
          done

          APPS_JSON="$APPS_JSON}"

          echo "apps<<EOF" >> $GITHUB_OUTPUT
          echo "$APPS_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo ""
          echo "ğŸ“¦ åº”ç”¨é…ç½®:"
          echo "$APPS_JSON" | jq .

  # åˆ›å»ºæˆ–æ›´æ–°é¢„è§ˆç¯å¢ƒ
  create-or-update-environment:
    needs: build-and-push
    if: github.event.action != 'closed' && needs.build-and-push.outputs.apps != ''
    runs-on: ubuntu-latest

    steps:
      - uses: actions/create-github-app-token@v2
        id: generate-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ env.INFRASTRUCTURE_REPO }}

      # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é¢„è§ˆç¯å¢ƒ
      - name: Check if environment exists
        id: check-env
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const branchName = `env/pr-${prNumber}`;

            try {
              // æŸ¥è¯¢ infrastructure ä»“åº“çš„ PR
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: 'infrastructure',
                state: 'open',
                head: `${context.repo.owner}:${branchName}`
              });

              const exists = prs.length > 0;

              if (exists) {
                console.log(`âœ… é¢„è§ˆç¯å¢ƒå·²å­˜åœ¨: PR #${prs[0].number}`);
                core.setOutput('exists', 'true');
                core.setOutput('event_type', 'pr-update');
              } else {
                console.log('ğŸ†• éœ€è¦åˆ›å»ºæ–°çš„é¢„è§ˆç¯å¢ƒ');
                core.setOutput('exists', 'false');
                core.setOutput('event_type', 'pr-create');
              }
            } catch (error) {
              console.log('âš ï¸  æ£€æŸ¥ç¯å¢ƒæ—¶å‡ºé”™ï¼Œé»˜è®¤ä¸ºåˆ›å»ºæ–°ç¯å¢ƒ');
              core.setOutput('exists', 'false');
              core.setOutput('event_type', 'pr-create');
            }

      # è§¦å‘ infrastructure ä»“åº“åˆ›å»ºæˆ–æ›´æ–°ç¯å¢ƒ
      - name: Trigger environment deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const eventType = '${{ steps.check-env.outputs.event_type }}';
            const owner = '${{ github.repository_owner }}'
            const repo = '${{ env.INFRASTRUCTURE_REPO }}'
            const apps = ${{ needs.build-and-push.outputs.apps }};

            await github.rest.repos.createDispatchEvent({
              owner: owner,
              repo: repo,
              event_type: eventType,
              client_payload: {
                pr_number: '${{ github.event.pull_request.number }}',
                source_repo: '${{ github.repository }}',
                apps: apps
              }
            });

            console.log(`âœ… å·²è§¦å‘ ${eventType} äº‹ä»¶`);
            console.log('Payload:', {
              pr_number: '${{ github.event.pull_request.number }}',
              source_repo: '${{ github.repository }}',
              apps: apps
            });

    # é”€æ¯é¢„è§ˆç¯å¢ƒ
    destroy-environment:
      if: github.event.action == 'closed'
      runs-on: ubuntu-latest

      steps:
        - uses: actions/create-github-app-token@v2
          id: generate-token
          with:
            app-id: ${{ secrets.APP_ID }}
            private-key: ${{ secrets.APP_PRIVATE_KEY }}
            owner: ${{ github.repository_owner }}
            repositories: ${{ env.INFRASTRUCTURE_REPO }}

        # å…³é—­ infrastructure ä»“åº“çš„ PRï¼ˆä¼šè§¦å‘é”€æ¯ï¼‰
        - name: Close infrastructure PR
          uses: actions/github-script@v7
          with:
            github-token: ${{ steps.generate-token.outputs.token }}
            script: |
              const prNumber = context.payload.pull_request.number;
              const branchName = `env/pr-${prNumber}`;

              try {
                // æŸ¥æ‰¾ infrastructure ä»“åº“çš„å¯¹åº” PR
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: 'infrastructure',
                  state: 'open',
                  head: `${context.repo.owner}:${branchName}`
                });

                if (prs.length > 0) {
                  const infraPR = prs[0];

                  // å…³é—­ PR
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: 'infrastructure',
                    pull_number: infraPR.number,
                    state: 'closed'
                  });

                  console.log(`âœ… å·²å…³é—­ infrastructure PR #${infraPR.number}`);
                } else {
                  console.log('âš ï¸  æœªæ‰¾åˆ°å¯¹åº”çš„ infrastructure PRï¼Œå¯èƒ½å·²è¢«åˆ é™¤');
                }
              } catch (error) {
                console.error('âŒ å…³é—­ PR å¤±è´¥:', error.message);
                // ä¸æŠ›å‡ºé”™è¯¯ï¼Œå› ä¸º PR å¯èƒ½å·²ç»è¢«æ‰‹åŠ¨å…³é—­
              }


