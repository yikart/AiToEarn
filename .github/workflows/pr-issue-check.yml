name: PR Issue Check

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  check-issue-linked:
    name: Check Issue Linked
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check if PR is linked to an issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            let prBody = context.payload.pull_request.body || '';
            const prTitle = context.payload.pull_request.title || '';
            
            const conventionalCommitsPattern = /^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?: .+$/;
            const validTypes = ['feat', 'fix', 'docs', 'style', 'refactor', 'perf', 'test', 'chore', 'ci', 'build'];
            
            if (!conventionalCommitsPattern.test(prTitle)) {
              const errorMessage = 
                '❌ PR title does not follow Conventional Commits format.\n\n' +
                'Required format: <type>(<scope>): <description>\n\n' +
                'Valid types:\n' +
                validTypes.map(t => `  - ${t}`).join('\n') + '\n\n' +
                'Examples:\n' +
                '  ✅ feat: add user authentication\n' +
                '  ✅ fix(web): resolve login button issue\n' +
                '  ✅ docs: update API documentation\n' +
                '  ✅ refactor(backend): improve error handling\n' +
                '  ✅ chore: update dependencies\n\n' +
                'Common mistakes:\n' +
                '  ❌ "Add new feature" (missing type and colon)\n' +
                '  ❌ "feat add feature" (missing colon)\n' +
                '  ❌ "feat: " (missing description)\n' +
                '  ❌ "feature: add something" (invalid type)\n\n' +
                `Current title: "${prTitle}"\n\n` +
                'Please update your PR title to follow the Conventional Commits specification.';
              
              core.setFailed(errorMessage);
              return;
            }
            
            console.log(`✅ PR title follows Conventional Commits format: "${prTitle}"`);
            
            prBody = prBody.replace(/<!--[\s\S]*?-->/g, '');
            
            const issuePattern = /(?:closes?|fixes?|resolves?|related to|refs?)\s*#(\d+)/gi;
            const matches = [];
            
            const bodyMatches = prBody.matchAll(issuePattern);
            for (const match of bodyMatches) {
              matches.push(parseInt(match[1]));
            }
            
            const titleWithoutComments = prTitle.replace(/<!--[\s\S]*?-->/g, '');
            const titlePattern = /(?:closes?|fixes?|resolves?|related to|refs?)\s*#(\d+)/gi;
            const titleMatches = titleWithoutComments.matchAll(titlePattern);
            for (const match of titleMatches) {
              matches.push(parseInt(match[1]));
            }
            
            const issueNumbers = [...new Set(matches)];
            
            if (issueNumbers.length === 0) {
              core.setFailed(
                '❌ This PR must be linked to an issue.\n\n' +
                'Please add one of the following to your PR description or title:\n' +
                '- Closes #123\n' +
                '- Fixes #123\n' +
                '- Resolves #123\n' +
                '- Related to #123\n' +
                '- Refs #123\n\n' +
                'You can link multiple issues: Closes #12, Related to #34'
              );
              return;
            }
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let validIssues = [];
            let invalidIssues = [];
            
            for (const issueNumber of issueNumbers) {
              try {
                const { data: issue } = await github.rest.issues.get({
                  owner: owner,
                  repo: repo,
                  issue_number: issueNumber,
                });
                
                if (!issue.pull_request) {
                  validIssues.push(issueNumber);
                  console.log(`✅ Found valid issue: #${issueNumber} - "${issue.title}"`);
                } else {
                  invalidIssues.push(issueNumber);
                  console.log(`⚠️  #${issueNumber} is a PR, not an issue`);
                }
              } catch (error) {
                invalidIssues.push(issueNumber);
                console.log(`❌ Issue #${issueNumber} not found or not accessible`);
                console.log(`Error details: ${error.message}`);
                if (error.status) {
                  console.log(`HTTP status: ${error.status}`);
                }
                if (error.status === 403) {
                  console.log(`⚠️  Permission denied. Make sure the workflow has 'issues: read' permission.`);
                } else if (error.status === 404) {
                  console.log(`⚠️  Issue #${issueNumber} not found in ${owner}/${repo}`);
                }
              }
            }
            
            if (validIssues.length === 0) {
              core.setFailed(
                '❌ No valid issues found linked to this PR.\n\n' +
                `Referenced: ${issueNumbers.map(n => `#${n}`).join(', ')}\n` +
                (invalidIssues.length > 0 
                  ? `Invalid or not found: ${invalidIssues.map(n => `#${n}`).join(', ')}\n`
                  : '') +
                '\nPlease ensure you link to a valid issue using:\n' +
                '- Closes #123\n' +
                '- Fixes #123\n' +
                '- Resolves #123\n' +
                '- Related to #123\n' +
                '- Refs #123'
              );
            } else {
              console.log(`✅ PR is linked to ${validIssues.length} valid issue(s): ${validIssues.map(n => `#${n}`).join(', ')}`);
            }

