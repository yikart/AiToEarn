name: Build Backend Images

on:
  push:
    branches:
      - main
    paths:
      - 'project/backend/**'
      - '.github/workflows/backend-build.yml'
  workflow_dispatch:
    inputs:
      build_aitoearn_channel:
        description: 'aitoearn-channel'
        required: false
        type: boolean
        default: false
      build_aitoearn_server:
        description: 'aitoearn-server'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      base_ref:
        description: 'Base branch for affected detection (for PR preview)'
        required: false
        type: string
        default: ''
      manual_apps:
        description: 'Comma-separated list of apps to build (for manual deployment)'
        required: false
        type: string
        default: ''
    outputs:
      has_changes:
        description: 'Whether any apps were affected'
        value: ${{ jobs.generate-matrix.outputs.has_changes }}

permissions:
  contents: read
  actions: write

env:
  DOCKER_HUB_USERNAME: aitoearn
  NX_NO_CLOUD: true
  MONOREPO_DIR: project/backend

jobs:
  parse-manual-apps:
    runs-on: ubuntu-latest
    outputs:
      manual_apps: ${{ steps.parse.outputs.manual_apps }}
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Parse manual app selection
        id: parse
        run: |
          APPS=""
          
          if [ "${{ inputs.build_aitoearn_admin_server }}" = "true" ]; then
            APPS="aitoearn-admin-server"
          fi
          
          if [ "${{ inputs.build_aitoearn_channel }}" = "true" ]; then
            if [ -n "$APPS" ]; then
              APPS="$APPS,aitoearn-channel"
            else
              APPS="aitoearn-channel"
            fi
          fi
          
          if [ "${{ inputs.build_aitoearn_payment }}" = "true" ]; then
            if [ -n "$APPS" ]; then
              APPS="$APPS,aitoearn-payment"
            else
              APPS="aitoearn-payment"
            fi
          fi
          
          if [ "${{ inputs.build_aitoearn_server }}" = "true" ]; then
            if [ -n "$APPS" ]; then
              APPS="$APPS,aitoearn-server"
            else
              APPS="aitoearn-server"
            fi
          fi
          
          if [ "${{ inputs.build_aitoearn_task }}" = "true" ]; then
            if [ -n "$APPS" ]; then
              APPS="$APPS,aitoearn-task"
            else
              APPS="aitoearn-task"
            fi
          fi
          
          echo "manual_apps=$APPS" >> $GITHUB_OUTPUT
          
          if [ -n "$APPS" ]; then
            echo "âœ… Manually selected apps: $APPS"
          else
            echo "âš ï¸  No apps selected"
          fi

  generate-matrix:
    runs-on: ubuntu-latest
    needs: [parse-manual-apps]
    if: always() && (needs.parse-manual-apps.result == 'success' || needs.parse-manual-apps.result == 'skipped')
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_changes: ${{ steps.set-matrix.outputs.has_changes }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ${{ env.MONOREPO_DIR }}/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: ${{ env.MONOREPO_DIR }}
        run: pnpm install --frozen-lockfile

      - name: Detect affected apps
        id: detect-changes
        working-directory: ${{ env.MONOREPO_DIR }}
        run: |
          # Get manually selected apps (from workflow_dispatch or workflow_call)
          MANUAL_APPS=""
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MANUAL_APPS="${{ needs.parse-manual-apps.outputs.manual_apps }}"
            if [ -z "$MANUAL_APPS" ]; then
              echo "âš ï¸  Manual trigger but no apps selected, will auto-detect affected apps"
            fi
          elif [ "${{ github.event_name }}" = "workflow_call" ] && [ -n "${{ inputs.manual_apps }}" ]; then
            MANUAL_APPS="${{ inputs.manual_apps }}"
          fi
          
          # Check if manual mode
          if [ -n "$MANUAL_APPS" ]; then
            echo "ðŸŽ¯ Manual build mode: Using specified app list"
            AFFECTED_APPS="$MANUAL_APPS"
            echo "âœ… Manually selected apps: $AFFECTED_APPS"
            echo "affected_apps=$AFFECTED_APPS" >> $GITHUB_OUTPUT

            echo ""
            echo "Details:"
            for APP in $(echo "$AFFECTED_APPS" | tr ',' ' '); do
              echo "  - $APP"
            done
          else
            # Set base branch based on trigger type
            if [ -n "${{ inputs.base_ref }}" ]; then
              BASE_REF="origin/${{ inputs.base_ref }}"
              echo "ðŸ“‹ PR mode: Detecting changes from $BASE_REF to HEAD"
            else
              BASE_REF="HEAD~1"
              if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                echo "ðŸ“‹ Manual trigger mode: Detecting changes from last commit"
              else
                echo "ðŸ“‹ Push mode: Detecting changes from last commit"
              fi
            fi

            echo "Base: $BASE_REF"
            echo "Head: HEAD"

            AFFECTED_APPS=$(pnpm nx show projects --affected --type=app --sep "," --exclude="@yikart/source" --exclude="browser-automation-worker" --base=$BASE_REF --head=HEAD 2>/dev/null || echo "")

            if [ -z "$AFFECTED_APPS" ]; then
              echo "âš ï¸  No affected apps detected"
              echo "affected_apps=" >> $GITHUB_OUTPUT
            else
              echo "âœ… Affected apps: $AFFECTED_APPS"
              echo "affected_apps=$AFFECTED_APPS" >> $GITHUB_OUTPUT

              echo ""
              echo "Details:"
              for APP in $(echo "$AFFECTED_APPS" | tr ',' ' '); do
                echo "  - $APP"
              done
            fi
          fi

      - name: Generate version
        id: version
        run: |
          VERSION="$(date +%Y%m%d)-$(git rev-parse --short HEAD)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Generate matrix
        id: set-matrix
        working-directory: ${{ env.MONOREPO_DIR }}
        run: |
          AFFECTED_APPS="${{ steps.detect-changes.outputs.affected_apps }}"
          VERSION="${{ steps.version.outputs.version }}"

          if [ -z "$AFFECTED_APPS" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "matrix={\"include\":[]}" >> $GITHUB_OUTPUT
            echo "âš ï¸  No changes, skipping build"
            exit 0
          fi

          echo "has_changes=true" >> $GITHUB_OUTPUT

          # Build matrix JSON array
          MATRIX_JSON="{"
          MATRIX_JSON="$MATRIX_JSON\"include\":["

          FIRST=true
          IFS=',' read -ra APPS <<< "$AFFECTED_APPS"

          for APP in "${APPS[@]}"; do
            IMAGE_TAG="${{ env.DOCKER_HUB_USERNAME }}/$APP:$VERSION"

            # Add to matrix
            if [ "$FIRST" = true ]; then
              FIRST=false
            else
              MATRIX_JSON="$MATRIX_JSON,"
            fi

            MATRIX_JSON="$MATRIX_JSON{\"app\":\"$APP\",\"image\":\"$IMAGE_TAG\"}"
          done

          MATRIX_JSON="$MATRIX_JSON]}"

          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸŽ¯ Matrix configuration:"
          echo "$MATRIX_JSON" | jq .

  build-and-push:
    needs: generate-matrix
    if: needs.generate-matrix.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: ${{ env.MONOREPO_DIR }}/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: ${{ env.MONOREPO_DIR }}
        run: pnpm install --frozen-lockfile

      - name: Restore Nx cache
        uses: actions/cache@v4
        with:
          path: ${{ env.MONOREPO_DIR }}/.nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('project/aitoearn-monorepo/pnpm-lock.yaml') }}-${{ matrix.app }}-${{ github.sha }}
          restore-keys: |
            nx-${{ runner.os }}-${{ hashFiles('project/aitoearn-monorepo/pnpm-lock.yaml') }}-${{ matrix.app }}-
            nx-${{ runner.os }}-${{ hashFiles('project/aitoearn-monorepo/pnpm-lock.yaml') }}-
            nx-${{ runner.os }}-

      - name: Build application
        working-directory: ${{ env.MONOREPO_DIR }}
        run: |
          echo "ðŸ”¨ Building app: ${{ matrix.app }}"
          pnpm nx run ${{ matrix.app }}:build

      - name: Prepare Docker context
        working-directory: ${{ env.MONOREPO_DIR }}
        run: pnpm nx run ${{ matrix.app }}:docker-context

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:latest
          buildkitd-flags: --debug

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.MONOREPO_DIR }}/tmp/docker-context
          file: ${{ env.MONOREPO_DIR }}/tmp/docker-context/Dockerfile
          platforms: linux/amd64
          build-args: |
            APP_NAME=${{ matrix.app }}
          tags: ${{ matrix.image }}
          push: true
          cache-from: |
            type=gha,scope=${{ matrix.app }}
            type=registry,ref=${{ env.DOCKER_HUB_USERNAME }}/${{ matrix.app }}:buildcache
          cache-to: |
            type=gha,mode=max,scope=${{ matrix.app }}
            type=inline
          provenance: false
          sbom: false

      - name: Build summary
        run: |
          echo "### âœ… Build successful: ${{ matrix.app }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ matrix.image }}\`" >> $GITHUB_STEP_SUMMARY

